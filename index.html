<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Выбор даты</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #f6f7f9);
      --card: var(--tg-theme-secondary-bg-color, #fff);
      --text: var(--tg-theme-text-color, #111);
      --muted: var(--tg-theme-hint-color, #6b7280);
      --stroke: rgba(0,0,0,.12);
      --radius-xl: 22px;
      --radius: 14px;
      --selected: #E6EBF5; /* цвет выбранной даты */
      --accent-grad: linear-gradient(0.25turn, rgba(96,211,147,1) 0%, rgba(99,213,236,1) 100%);
    }
    *{ box-sizing: border-box; }
    body{
      margin:0; padding:20px; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .card{
      background:var(--card); border-radius:var(--radius-xl); padding:18px;
      max-width:760px; margin:0 auto; box-shadow:0 1px 4px rgba(0,0,0,.06);
    }
    h1{ font-size:24px; margin:0 0 16px; }
    label{ display:block; font-size:18px; margin:8px 0; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
    .row.nav{ justify-content:space-between; }
    select{
      flex:1 1 180px; padding:12px 14px; border:1px solid var(--stroke);
      border-radius:var(--radius); font-size:16px; background:#fff;
    }
    .arrow{
      width:44px; height:44px; border:1px solid var(--stroke); border-radius:12px;
      background:#fff; font-size:22px; line-height:1; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }

    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
    .dow{ text-align:center; font-size:14px; color:var(--muted); margin-top:4px; }
    .day{
      text-align:center; padding:12px 0; border:1px solid var(--stroke);
      border-radius:12px; background:#fff; font-size:16px; cursor:pointer;
      user-select:none;
    }
    .day.empty{ visibility:hidden; }
    .day.disabled{ opacity:.4; pointer-events:none; }
    .day.selected{ background:var(--selected); border-color:var(--selected); }

    .muted{ font-size:15px; color:var(--muted); margin-top:12px; }

    .btn{
      width:100%; margin-top:16px; padding:14px 16px; border:0; border-radius:14px;
      font-size:17px; font-weight:600; color:#fff;              /* белый текст */
      background:var(--accent-grad); cursor:pointer;
      box-shadow:0 6px 16px rgba(99,213,236,.25);
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    @media (max-width:420px){
      body{ padding:14px; }
      h1{ font-size:22px; }
      .day{ padding:10px 0; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Выберите дату тура</h1>
    <label>Дата</label>

    <!-- навигация: стрелки + выпадающие списки -->
    <div class="row nav">
      <button class="arrow" id="prev" aria-label="Предыдущий месяц">‹</button>
      <select id="month"></select>
      <select id="year"></select>
      <button class="arrow" id="next" aria-label="Следующий месяц">›</button>
    </div>

    <!-- дни недели -->
    <div class="grid" id="dow"></div>
    <!-- сетка дней -->
    <div class="grid" id="days"></div>

    <div class="muted">Нажмите «Готово» ниже, чтобы подтвердить.</div>
    <button id="submit" class="btn" disabled>Готово</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();
    tg.MainButton.hide(); // используем свою кнопку

    // ===== модель и константы =====
    const RU_MONTHS = [
      "Январь","Февраль","Март","Апрель","Май","Июнь",
      "Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"
    ];
    const DOW = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
    const now = new Date();
    const currentYear = now.getFullYear();
    const years = [currentYear, currentYear+1, currentYear+2]; // два года вперёд

    const sel = { y: currentYear, m: now.getMonth(), d: now.getDate() };

    const monthEl = document.getElementById('month');
    const yearEl  = document.getElementById('year');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const dowEl   = document.getElementById('dow');
    const daysEl  = document.getElementById('days');
    const btn     = document.getElementById('submit');

    // ===== отрисовка =====
    function renderDOW(){
      dowEl.innerHTML = "";
      DOW.forEach(n => {
        const div = document.createElement('div');
        div.className = 'dow';
        div.textContent = n;
        dowEl.appendChild(div);
      });
    }
    function fillSelects(){
      monthEl.innerHTML = RU_MONTHS.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
      yearEl.innerHTML  = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      monthEl.value = sel.m;
      yearEl.value  = sel.y;
    }
    function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
    function firstWeekdayIndex(y,m){ let w=new Date(y,m,1).getDay(); return (w+6)%7; } // Пн=0..Вс=6

    function renderDays(){
      daysEl.innerHTML = "";
      const y = +yearEl.value, m = +monthEl.value;
      const blanks = firstWeekdayIndex(y,m);
      const count = daysInMonth(y,m);

      // пустые ячейки до 1-го числа
      for(let i=0;i<blanks;i++){
        const e = document.createElement('div');
        e.className = 'day empty';
        daysEl.appendChild(e);
      }
      // сами дни
      for(let d=1; d<=count; d++){
        const e = document.createElement('div');
        e.className = 'day';
        e.textContent = d;
        if (sel.y===y && sel.m===m && sel.d===d) e.classList.add('selected');
        e.onclick = ()=>{
          sel.y = y; sel.m = m; sel.d = d;
          Array.from(daysEl.children).forEach(c=>c.classList.remove('selected'));
          e.classList.add('selected');
          btn.disabled = false;
        };
        daysEl.appendChild(e);
      }
    }

    // ===== навигация стрелками =====
    function shiftMonth(delta){
      let y = Number(yearEl.value);
      let m = Number(monthEl.value) + delta;

      if (m < 0){ m = 11; y -= 1; }
      if (m > 11){ m = 0;  y += 1; }

      const minY = years[0], maxY = years[years.length-1];
      if (y < minY){ y = minY; m = 0; }
      if (y > maxY){ y = maxY; m = 11; }

      yearEl.value  = y;
      monthEl.value = m;
      renderDays();
    }

    // ===== инициализация =====
    renderDOW();
    fillSelects();
    renderDays();

    monthEl.onchange = ()=> renderDays();
    yearEl.onchange  = ()=> renderDays();
    prevBtn.onclick  = ()=> shiftMonth(-1);
    nextBtn.onclick  = ()=> shiftMonth(1);

    // ===== отправка в бота =====
    function toISO(y,m,d){
      const dt = new Date(Date.UTC(y, m, d)); // UTC, чтобы не «плавало»
      return dt.toISOString().slice(0,10);
    }
    btn.onclick = ()=>{
      if (!sel.d) return;
      const iso = toISO(sel.y, sel.m, sel.d);
      tg.sendData(JSON.stringify({ date: iso }));
    };
  </script>
</body>
</html>
