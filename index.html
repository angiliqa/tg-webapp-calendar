<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Выбор даты тура</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #f6f7f9);
      --card: var(--tg-theme-secondary-bg-color, #fff);
      --text: var(--tg-theme-text-color, #111);
      --muted: var(--tg-theme-hint-color, #6b7280);
      --stroke: rgba(0,0,0,.12);
      --radius-xl: 22px;
      --radius: 14px;                     /* единый радиус и для селектов, и для кнопки */
      --ctl-h: 48px;                      /* единая высота контролов */
      --selected: #E6EBF5;                /* цвет выбранного дня */
      --accent-grad: linear-gradient(0.25turn, rgba(96,211,147,1) 0%, rgba(99,213,236,1) 100%);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:20px; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .card{
      background:var(--card); border-radius:var(--radius-xl); padding:18px;
      max-width:760px; margin:0 auto; box-shadow:0 1px 4px rgba(0,0,0,.06);
    }
    h1{ font-size:24px; margin:0 0 16px; }
    label{ display:block; font-size:18px; margin:6px 0 10px; }

    /* Ряд: стрелка — селект — стрелка (одинаковая высота и радиусы) */
    .control{
      display:grid;
      grid-template-columns: var(--ctl-h) 1fr var(--ctl-h);
      gap:12px;
      margin-bottom:10px;
      align-items:center;
    }

    /* Кнопки-стрелки: тот же градиент, что у кнопки «Готово» */
    .arrow{
      height:var(--ctl-h); width:var(--ctl-h);
      border:0; border-radius:var(--radius);
      background: var(--accent-grad);
      color:#fff; font-size:22px; line-height:1;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
      box-shadow:0 6px 16px rgba(99,213,236,.25);
      transition: transform .03s ease, filter .15s ease;
    }
    .arrow:active{ transform: translateY(1px); filter:brightness(.98); }

    /* Обёртка селекта: скругление и красивый фокус */
    .select-wrap{
      height:var(--ctl-h);
      border-radius:var(--radius);
      border:1.5px solid var(--stroke);
      background:#fff;
      overflow:hidden; display:flex; align-items:center;
      transition: border-color .15s ease;
    }
    /* при фокусе – градиентная рамка как у кнопки */
    .select-wrap.focus{
      border: 1.5px solid transparent;
      background:
        linear-gradient(#fff,#fff) padding-box,
        var(--accent-grad) border-box;
    }
    /* сам <select> — чёрный текст, без нативного блика */
    select{
      flex:1 1 auto; height:100%; padding:0 14px; border:0;
      background:transparent; color:#111; font-size:16px;
      appearance:none; -webkit-appearance:none; outline:none;
    }

    .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .dow{ text-align:center; font-size:14px; color:var(--muted); margin-top:6px; }
    .day{
      text-align:center; padding:12px 0; border:1px solid var(--stroke);
      border-radius:12px; background:#fff; font-size:16px; cursor:pointer;
      user-select:none;
    }
    .day.empty{ visibility:hidden; }
    .day.selected{ background:var(--selected); border-color:var(--selected); }

    .muted{ font-size:15px; color:var(--muted); margin-top:12px; }
    .btn{
      width:100%; margin-top:16px; padding:14px 16px; border:0; border-radius:14px;
      font-size:17px; font-weight:600; color:#fff; background:var(--accent-grad);
      cursor:pointer; box-shadow:0 6px 16px rgba(99,213,236,.25);
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    @media (max-width:420px){
      body{ padding:14px; }
      h1{ font-size:22px; }
      :root{ --ctl-h: 44px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Выберите дату тура</h1>
    <label>Дата</label>

    <!-- МЕСЯЦ -->
    <div class="control">
      <button class="arrow" id="m-prev" aria-label="Предыдущий месяц">‹</button>
      <div class="select-wrap" id="wrap-month">
        <select id="month"></select>
      </div>
      <button class="arrow" id="m-next" aria-label="Следующий месяц">›</button>
    </div>

    <!-- ГОД -->
    <div class="control">
      <button class="arrow" id="y-prev" aria-label="Предыдущий год">‹</button>
      <div class="select-wrap" id="wrap-year">
        <select id="year"></select>
      </div>
      <button class="arrow" id="y-next" aria-label="Следующий год">›</button>
    </div>

    <!-- Дни недели и сетка -->
    <div class="grid" id="dow"></div>
    <div class="grid" id="days"></div>

    <div class="muted">Нажмите «Готово» ниже, чтобы подтвердить.</div>
    <button id="submit" class="btn" disabled>Готово</button>
  </div>

  <script>
    // Telegram init
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready(); tg.MainButton.hide();

    // Константы/состояние
    const RU_MONTHS = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const DOW = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
    const now = new Date();
    const currentYear = now.getFullYear();
    const years = [currentYear, currentYear+1, currentYear+2]; // 2 года вперёд
    const sel = { y: currentYear, m: now.getMonth(), d: null }; // без предвыбора дня

    // DOM
    const monthEl = document.getElementById('month');
    const yearEl  = document.getElementById('year');
    const mPrev   = document.getElementById('m-prev');
    const mNext   = document.getElementById('m-next');
    const yPrev   = document.getElementById('y-prev');
    const yNext   = document.getElementById('y-next');
    const wrapMonth = document.getElementById('wrap-month');
    const wrapYear  = document.getElementById('wrap-year');
    const dowEl   = document.getElementById('dow');
    const daysEl  = document.getElementById('days');
    const btn     = document.getElementById('submit');

    // Фокус-подсветка селектов
    function bindFocusWrap(select, wrap){
      select.addEventListener('focus', ()=>wrap.classList.add('focus'));
      select.addEventListener('blur',  ()=>wrap.classList.remove('focus'));
      select.addEventListener('change',()=>wrap.classList.remove('focus')); // iOS fix
    }

    // Шапка дней недели
    function renderDOW(){
      dowEl.innerHTML = "";
      DOW.forEach(n => {
        const div = document.createElement('div');
        div.className = 'dow';
        div.textContent = n;
        dowEl.appendChild(div);
      });
    }

    // Селекты
    function fillSelects(){
      monthEl.innerHTML = RU_MONTHS.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
      yearEl.innerHTML  = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      monthEl.value = sel.m; yearEl.value = sel.y;
    }

    // Вспомогательные
    const daysInMonth      = (y,m)=> new Date(y, m+1, 0).getDate();
    const firstWeekdayIndex= (y,m)=> (new Date(y,m,1).getDay()+6)%7; // Пн=0..Вс=6
    const toISO            = (y,m,d)=> new Date(Date.UTC(y,m,d)).toISOString().slice(0,10);

    // Сетка дней
    function renderDays(){
      daysEl.innerHTML = "";
      const y = +yearEl.value, m = +monthEl.value;
      const blanks = firstWeekdayIndex(y,m);
      const count = daysInMonth(y,m);

      for(let i=0;i<blanks;i++){
        const e = document.createElement('div'); e.className='day empty'; daysEl.appendChild(e);
      }
      for(let d=1; d<=count; d++){
        const e = document.createElement('div'); e.className='day'; e.textContent=d;
        if (sel.y===y && sel.m===m && sel.d===d) e.classList.add('selected');
        e.onclick = ()=>{
          sel.y=y; sel.m=m; sel.d=d;
          Array.from(daysEl.children).forEach(c=>c.classList.remove('selected'));
          e.classList.add('selected');
          btn.disabled=false;
        };
        daysEl.appendChild(e);
      }
    }

    // Навигация
    function shiftMonth(delta){
      let y = Number(yearEl.value);
      let m = Number(monthEl.value) + delta;
      if (m<0){ m=11; y--; }
      if (m>11){ m=0;  y++; }
      const minY=years[0], maxY=years[years.length-1];
      if (y<minY){ y=minY; m=0; }
      if (y>maxY){ y=maxY; m=11; }
      yearEl.value=y; monthEl.value=m; renderDays();
    }
    function shiftYear(delta){
      let y = Number(yearEl.value) + delta;
      const minY=years[0], maxY=years[years.length-1];
      if (y<minY) y=minY;
      if (y>maxY) y=maxY;
      yearEl.value=y; renderDays();
    }

    // Инициализация
    renderDOW(); fillSelects(); renderDays();
    bindFocusWrap(monthEl, wrapMonth);
    bindFocusWrap(yearEl,  wrapYear);
    monthEl.onchange=renderDays; yearEl.onchange=renderDays;
    mPrev.onclick=()=>shiftMonth(-1); mNext.onclick=()=>shiftMonth(1);
    yPrev.onclick=()=>shiftYear(-1);  yNext.onclick=()=>shiftYear(1);

    // Отправка в бота
    btn.onclick=()=>{
      if(!sel.d) return;
      const iso = toISO(sel.y, sel.m, sel.d);            // YYYY-MM-DD
      tg.sendData(JSON.stringify({ date: iso }));
    };
  </script>
</body>
</html>

