<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Выбор даты</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

  <style>
    :root{
      --card-bg: var(--tg-theme-secondary-bg-color, #fff);
      --text: var(--tg-theme-text-color, #111);
      --muted: var(--tg-theme-hint-color, #6b7280);
      --stroke: rgba(0,0,0,.12);
      --radius-xl: 22px;
      --radius: 14px;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0; padding:20px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: var(--tg-theme-bg-color, #f6f7f9);
    }
    .card{
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 18px 18px 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
      overflow: hidden; /* чтобы внутренности не вылазили за скругление */
      max-width: 680px; margin: 0 auto;
    }
    h1{ font-size: 24px; line-height: 1.25; margin: 0 0 16px; }
    label{ display:block; font-size:18px; margin: 4px 0 8px; }
    /* поле – внутри не вылезает за края */
    input[type="text"].date-input{
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      font-size: 18px;
      line-height: 1.2;
      background: #fff;
    }
    .muted{ font-size: 15px; color: var(--muted); margin-top: 12px; }

    /* СДЕЛАТЬ КАЛЕНДАРЬ КРУПНЫМ */
    .flatpickr-calendar{
      font-size: 16px;          /* базовый размер */
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
    }
    .flatpickr-days{ border-radius: 12px; }
    .flatpickr-day{ height: 42px; line-height: 42px; } /* крупные ячейки */
    .flatpickr-months .flatpickr-month{ height: 48px; }
    .flatpickr-current-month .cur-month, 
    .flatpickr-current-month .numInputWrapper input{
      font-size: 18px;
    }

    /* на узких экранах добавим небольшие отступы */
    @media (max-width: 420px){
      body{ padding: 14px; }
      h1{ font-size: 22px; }
      .flatpickr-day{ height: 38px; line-height: 38px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Выберите дату тура</h1>
    <label for="date">Дата</label>
    <!-- это текстовое поле под Flatpickr -->
    <input id="date" class="date-input" type="text" placeholder="дд.мм.гггг" readonly />
    <div class="muted">Нажмите «Готово» внизу, чтобы подтвердить.</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // Основная кнопка Telegram
    tg.MainButton.setText('Готово');
    tg.MainButton.show();
    tg.MainButton.disable();

    // Диапазон: сегодня .. +365 дней
    const today = new Date();
    const max = new Date(today);
    max.setDate(max.getDate() + 365);

    // Инициализация Flatpickr (всегда кастомный календарь, даже на iOS)
    const input = document.getElementById('date');
    const fp = flatpickr(input, {
      locale: 'ru',
      disableMobile: true,
      dateFormat: 'd.m.Y',           // что видит пользователь
      defaultDate: today,            // можно убрать, если без авто-даты
      minDate: today,
      maxDate: max,
      position: 'auto center',
      static: false,                 // всплывающее окно
      onReady: (sel, str, inst) => {
        // Откроем календарь сразу, чтобы не нужно было нажимать поле
        setTimeout(() => inst.open(), 50);
      },
      onChange: (selectedDates) => {
        if (selectedDates && selectedDates[0]) {
          tg.MainButton.enable();
          // Запомним ISO для отправки в бота (локальная дата без сдвига часового пояса)
          const d = selectedDates[0];
          const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000)
                        .toISOString().slice(0,10); // YYYY-MM-DD
          input.dataset.iso = iso;
        } else {
          tg.MainButton.disable();
          delete input.dataset.iso;
        }
      }
    });

    // Отправка данных в бота
    tg.MainButton.onClick(() => {
      const iso = input.dataset.iso;
      if (!iso) { tg.showAlert('Выберите дату'); return; }
      const payload = { date: iso };  // n8n ждёт поле date в ISO
      tg.sendData(JSON.stringify(payload));
    });
  </script>
</body>
</html>
